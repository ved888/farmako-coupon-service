# 🏷️ Farmako Coupon Service

A production-ready, concurrency-safe **Coupon System MVP** built in Go, designed as part of a **medicine ordering platform**. This system allows **admins to create coupons** and **users to validate coupons** with robust constraint checks, caching, database-backed persistence, and a well-documented REST API.

---

## 📌 Features

- 🚀 Admin coupon creation and management
- ✅ Coupon validation with strict rule enforcement
- 🔄 Caching layer using `go-cache` (an in-memory key-value store with TTL support)
- 🧵 Concurrency-safe operations
- 💾 PostgreSQL persistence with raw SQL 
- 🧰 Clean, modular Go architecture
- 📚 Swagger/OpenAPI documentation
- 🐳 Docker support with `docker-compose`
- 🛡️ Middleware for logging and request context

---

## 📁 Project Structure

```
farmako-coupon-service/
│
├── cmd/                 # Entry point (main.go)
├── cache/               # In-memory cache logic
├── database/            # PostgreSQL connection and migrations
├── dbhelper/            # Coupon DB operations
├── handler/             # Business logic and validation
├── models/              # Data models and structs
├── middleware/          # Request logging and context handling
├── server/              # Routes grouped by user/admin/public
├── utils/               # Utility functions
├── docs/                # Swagger documentation (autogenerated)
├── Dockerfile           # Docker build instructions
├── docker-compose.yml   # Local container orchestration
├── wait-for-it.sh       # DB readiness check for Docker
└── README.md            # This file
```

---

## ⚙️ Tech Stack

- **Golang 1.21+**
- **PostgreSQL** (via `database/sql`)
- **Swagger (swaggo)** for API docs
- **Docker & Docker Compose**
- **Chi Router** for routing
- **In-memory cache** (can be extended with Redis/LRU)

---

## 🚀 Getting Started

### 📦 1. Set Environment Variables

Create a `.env` file:

```env
PORT=8080
DB_HOST=db
DB_PORT=5432
DB_NAME=yourDbName
DB_USER=postgres
DB_PASS=yourpassword
```

---

## 🐳 Run with Docker (Recommended)

Make sure Docker is running, then:

```bash
sudo docker compose up --build
```

Swagger will be available at:

```
http://localhost:8080/docs/index.html
```

---

## 🧪 Run Without Docker (Manual Mode)

### Step 1: Install Dependencies

```bash
go mod tidy
```

### Step 2: Run Migrations

Use `.sql` files in `database/migrations/` or run them manually in PostgreSQL.

### Step 3: Start Server

```bash
go run cmd/main.go
```

---

## 📜 Swagger API Docs

### Generate Swagger Files

```bash
go install github.com/swaggo/swag/cmd/swag@latest

swag init -g cmd/main.go
```

### Access Swagger UI

Once the server is running:

```
http://localhost:8080/docs/index.html
```

---

## 🔗 API Endpoints

### ✅ Admin: Create Coupon

`POST /v1/admin/coupons`

```json
{
  "coupon_code": "SAVE20",
  "discount_type": "percentage",
  "discount_value": 20,
  "expiry_date": "2025-12-31T23:59:59Z",
  "usage_type": "multi_use",
  "applicable_medicine_ids": ["med123"],
  "applicable_categories": ["painkiller"],
  "min_order_value": 500,
  "valid_from": "2025-01-01T00:00:00Z",
  "valid_to": "2025-12-31T23:59:59Z",
  "terms_and_conditions": "Valid for specific medicines only",
  "max_usage_per_user": 1,
  "target": "inventory"
}
```

---

### 📥 User: Get Applicable Coupons

`GET /v1/coupons/applicable`

```json
{
  "cart_items": [
    { "id": "med123", "category": "painkiller" }
  ],
  "order_total": 700,
  "timestamp": "2025-05-05T15:00:00Z"
}
```

**Response:**

```json
{
  "applicable_coupons": [
    {
      "coupon_code": "SAVE20",
      "discount_value": 20
    }
  ]
}
```

---

### 🧾 User: Validate Coupon

`POST /v1/coupons/validate`

```json
{
  "coupon_code": "SAVE20",
  "cart_items": [...],
  "order_total": 700,
  "timestamp": "2025-05-05T15:00:00Z"
}
```

✅ **Success Response**:

```json
{
  "is_valid": true,
  "discount": {
    "items_discount": 50,
    "charges_discount": 20
  },
  "message": "coupon applied successfully"
}
```

❌ **Failure Response**:

```json
{
  "is_valid": false,
  "reason": "coupon expired or not applicable"
}
```

---

## 🧠 Architectural Overview

- **Database Layer** (`dbhelper`): Handles raw SQL queries to PostgreSQL
- **Caching Layer** (`cache`): In-memory map with TTL simulation (can extend to Redis or LRU)
- **Validation Logic** (`handler`): Business rules around coupon validation
- **Routing Layer** (`server`): Cleanly separates public vs admin routes
- **Middleware**: Logging and contextual metadata per request
- **Swagger**: Documents all routes via annotations

---

## 🔒 Concurrency & Caching

- Coupon usage tracking is **mutex-guarded** to prevent race conditions
- Coupon info is **cached in memory** for fast lookup and to reduce DB hits
- All validation routines are designed to be **goroutine-safe**
- Coupon usage insertions use **PostgreSQL constraints** for idempotency

---

## ✅ Deliverables Checklist

| Requirement                         | Status      |
|------------------------------------|-------------|
| Admin Coupon Creation              | ✅ Implemented |
| Coupon Validation                  | ✅ Implemented |
| Persistent Storage (PostgreSQL)   | ✅ Done (manual SQL) |
| Caching Layer                      | ✅ In-memory |
| OpenAPI Docs (Swagger)            | ✅ Available |
| Dockerized                         | ✅ Yes       |
| Graceful Shutdown + Context       | ✅ Done      |
| README.md with architecture/setup | ✅ You're reading it! |

---

## 👨‍💻 Author

**Ved Prakash Verma**  
Backend Developer – Golang | Docker | PostgreSQL  
📍 Varanasi, India  
[LinkedIn](https://www.linkedin.com/in/vedprakashverma555/
)

---
