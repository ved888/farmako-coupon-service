# ğŸ·ï¸ Farmako Coupon Service

A production-ready, concurrency-safe **Coupon System MVP** built in Go, designed as part of a **medicine ordering platform**. This system allows **admins to create coupons** and **users to validate coupons** with robust constraint checks, caching, database-backed persistence, and a well-documented REST API.

---

## ğŸ“Œ Features

- ğŸš€ Admin coupon creation and management
- âœ… Coupon validation with strict rule enforcement
- ğŸ”„ Caching layer using `go-cache` (an in-memory key-value store with TTL support)
- ğŸ§µ Concurrency-safe operations
- ğŸ’¾ PostgreSQL persistence with raw SQL 
- ğŸ§° Clean, modular Go architecture
- ğŸ“š Swagger/OpenAPI documentation
- ğŸ³ Docker support with `docker-compose`
- ğŸ›¡ï¸ Middleware for logging and request context

---

## ğŸ“ Project Structure

```
farmako-coupon-service/
â”‚
â”œâ”€â”€ cmd/                 # Entry point (main.go)
â”œâ”€â”€ cache/               # In-memory cache logic
â”œâ”€â”€ database/            # PostgreSQL connection and migrations
â”œâ”€â”€ dbhelper/            # Coupon DB operations
â”œâ”€â”€ handler/             # Business logic and validation
â”œâ”€â”€ models/              # Data models and structs
â”œâ”€â”€ middleware/          # Request logging and context handling
â”œâ”€â”€ server/              # Routes grouped by user/admin/public
â”œâ”€â”€ utils/               # Utility functions
â”œâ”€â”€ docs/                # Swagger documentation (autogenerated)
â”œâ”€â”€ Dockerfile           # Docker build instructions
â”œâ”€â”€ docker-compose.yml   # Local container orchestration
â”œâ”€â”€ wait-for-it.sh       # DB readiness check for Docker
â””â”€â”€ README.md            # This file
```

---

## âš™ï¸ Tech Stack

- **Golang 1.21+**
- **PostgreSQL** (via `database/sql`)
- **Swagger (swaggo)** for API docs
- **Docker & Docker Compose**
- **Chi Router** for routing
- **In-memory cache** (can be extended with Redis/LRU)

---

## ğŸš€ Getting Started

### ğŸ“¦ 1. Set Environment Variables

Create a `.env` file:

```env
PORT=8080
DB_HOST=db
DB_PORT=5432
DB_NAME=yourDbName
DB_USER=postgres
DB_PASS=yourpassword
```

---

## ğŸ³ Run with Docker (Recommended)

Make sure Docker is running, then:

```bash
sudo docker compose up --build
```

Swagger will be available at:

```
http://localhost:8080/docs/index.html
```

---

## ğŸ§ª Run Without Docker (Manual Mode)

### Step 1: Install Dependencies

```bash
go mod tidy
```

### Step 2: Run Migrations

Use `.sql` files in `database/migrations/` or run them manually in PostgreSQL.

### Step 3: Start Server

```bash
go run cmd/main.go
```

---

## ğŸ“œ Swagger API Docs

### Generate Swagger Files

```bash
go install github.com/swaggo/swag/cmd/swag@latest

swag init -g cmd/main.go
```

### Access Swagger UI

Once the server is running:

```
http://localhost:8080/docs/index.html
```

---

## ğŸ”— API Endpoints

### âœ… Admin: Create Coupon

`POST /v1/admin/coupons`

```json
{
  "coupon_code": "SAVE20",
  "discount_type": "percentage",
  "discount_value": 20,
  "expiry_date": "2025-12-31T23:59:59Z",
  "usage_type": "multi_use",
  "applicable_medicine_ids": ["med123"],
  "applicable_categories": ["painkiller"],
  "min_order_value": 500,
  "valid_from": "2025-01-01T00:00:00Z",
  "valid_to": "2025-12-31T23:59:59Z",
  "terms_and_conditions": "Valid for specific medicines only",
  "max_usage_per_user": 1,
  "target": "inventory"
}
```

---

### ğŸ“¥ User: Get Applicable Coupons

`GET /v1/coupons/applicable`

```json
{
  "cart_items": [
    { "id": "med123", "category": "painkiller" }
  ],
  "order_total": 700,
  "timestamp": "2025-05-05T15:00:00Z"
}
```

**Response:**

```json
{
  "applicable_coupons": [
    {
      "coupon_code": "SAVE20",
      "discount_value": 20
    }
  ]
}
```

---

### ğŸ§¾ User: Validate Coupon

`POST /v1/coupons/validate`

```json
{
  "coupon_code": "SAVE20",
  "cart_items": [...],
  "order_total": 700,
  "timestamp": "2025-05-05T15:00:00Z"
}
```

âœ… **Success Response**:

```json
{
  "is_valid": true,
  "discount": {
    "items_discount": 50,
    "charges_discount": 20
  },
  "message": "coupon applied successfully"
}
```

âŒ **Failure Response**:

```json
{
  "is_valid": false,
  "reason": "coupon expired or not applicable"
}
```

---

## ğŸ§  Architectural Overview

- **Database Layer** (`dbhelper`): Handles raw SQL queries to PostgreSQL
- **Caching Layer** (`cache`): In-memory map with TTL simulation (can extend to Redis or LRU)
- **Validation Logic** (`handler`): Business rules around coupon validation
- **Routing Layer** (`server`): Cleanly separates public vs admin routes
- **Middleware**: Logging and contextual metadata per request
- **Swagger**: Documents all routes via annotations

---

## ğŸ”’ Concurrency & Caching

- Coupon usage tracking is **mutex-guarded** to prevent race conditions
- Coupon info is **cached in memory** for fast lookup and to reduce DB hits
- All validation routines are designed to be **goroutine-safe**
- Coupon usage insertions use **PostgreSQL constraints** for idempotency

---

## âœ… Deliverables Checklist

| Requirement                         | Status      |
|------------------------------------|-------------|
| Admin Coupon Creation              | âœ… Implemented |
| Coupon Validation                  | âœ… Implemented |
| Persistent Storage (PostgreSQL)   | âœ… Done (manual SQL) |
| Caching Layer                      | âœ… In-memory |
| OpenAPI Docs (Swagger)            | âœ… Available |
| Dockerized                         | âœ… Yes       |
| Graceful Shutdown + Context       | âœ… Done      |
| README.md with architecture/setup | âœ… You're reading it! |

---

## ğŸ‘¨â€ğŸ’» Author

**Ved Prakash Verma**  
Backend Developer â€“ Golang | Docker | PostgreSQL  
ğŸ“ Varanasi, India  
[LinkedIn](https://www.linkedin.com/in/vedprakashverma555/
)

---
